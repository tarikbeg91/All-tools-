<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World FM - ‡§∏‡§∞‡§≤ ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§§‡•ç‡§Æ‡§ï</title>
    <style>
        body { background: #f0f0f0; font-family: Arial, sans-serif; color: #333; margin: 0; padding: 0; }
        .radio-container { width: 90%; max-width: 600px; margin: 20px auto; padding: 20px; background: #8B4513; border: 5px solid #654321; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.6); color: #fff; }
        .display-area { margin-bottom: 15px; }
        .main-display { font-family: 'Courier New', monospace; color: #00FF00; background: #000; padding: 10px; text-align: center; font-size: 14px; border-radius: 5px; min-height: 36px; margin-bottom: 5px; word-wrap: break-word; transition: color 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .main-display .playing-info, .main-display .status-info { display: block; width: 100%; }
        .now-playing-display { font-family: 'Arial', sans-serif; color: #FFFF00; background: #222; padding: 5px 10px; text-align: center; font-size: 14px; border-radius: 5px; min-height: 18px; font-style: italic; word-wrap: break-word; }
        /* ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ CSS ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ */
        .player-controls-area { margin-bottom: 15px; }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 10px; }
        .player-controls button { background-color: #D2B48C; color: #333; border: 1px solid #654321; border-radius: 50%; width: 38px; height: 38px; font-size: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 0; transition: background-color 0.2s, transform 0.1s, color 0.2s, border-color 0.2s; }
        .player-controls button:active { transform: scale(0.95); }
        @keyframes pulse_green { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }
        .player-controls button#stop-save-btn.recording-active { animation: pulse_green 1.5s infinite; border-color: #28a745; color: #28a745; }
        .player-controls button#cancel-record-btn.recording-active { border-color: #dc3545; color: #dc3545; }
        .player-controls button#record-btn.can-record { color: green; }
        .player-controls button:hover { background-color: #DEB887; }
        .player-controls button:disabled { background-color: #aaa !important; color: #666 !important; cursor: not-allowed; animation: none !important; box-shadow: none !important; }
        .recording-quality-selector, .sleep-timer-controls { text-align: center; margin-bottom: 10px; font-size: 14px; }
        .recording-quality-selector label, .sleep-timer-controls label { margin-right: 5px; }
        .recording-quality-selector select, .sleep-timer-controls select { padding: 5px; border-radius: 4px; border: 1px solid #654321; background-color: #D2B48C; color: #333; font-size: 13px; }
        #sleep-timer-display { margin-left: 10px; font-style: italic; color: #FFD700; }
        audio { width: 100%; margin-bottom: 15px; }
        .navigation-tabs { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .navigation-tabs button { padding: 8px 10px; background-color: #D2B48C; color: #333; border: 1px solid #8B4513; border-radius: 5px; cursor: pointer; font-size: 13px; flex-grow: 1; }
        .navigation-tabs button:hover, .navigation-tabs button.active { background-color: #DEB887; font-weight: bold; }
        .navigation-tabs button:disabled { background-color: #ccc !important; color: #888 !important; cursor: not-allowed; }
        .country-search-area { margin-bottom: 15px; }
        #country-select, #search-station { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        #country-select:disabled, #search-station:disabled { background-color: #eee; cursor: not-allowed; }
        #station-list { list-style: none; padding: 0; max-height: 240px; /* ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§ö‡§Ø‡§®‡§ï‡§∞‡•ç‡§§‡§æ ‡§î‡§∞ ‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§ó‡§π */ overflow-y: auto; border: 1px solid #654321; border-radius: 5px; background-color: #A0522D; }
        #station-list li { padding: 8px 12px; background: #D2B48C; color: #333; cursor: pointer; font-size: 15px; border-bottom: 1px solid #8B4513; display: flex; align-items: center; }
        #station-list li.broken-stream { opacity: 0.6; }
        #station-list li.broken-stream .station-name::after { content: " ‚ö†Ô∏è"; color: red; font-size: 12px; }
        #station-list li:last-child { border-bottom: none; }
        #station-list li:hover { background: #DEB887; }
        #station-list li.playing { background: #FFD700; color: #000; font-weight: bold; }
        .station-favicon { width: 24px; height: 24px; margin-right: 10px; border-radius: 3px; background-color: #eee; object-fit: contain; vertical-align: middle; flex-shrink: 0; }
        .station-details { flex-grow: 1; overflow: hidden; }
        .station-name { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .station-bitrate { font-size: 12px; color: #555; margin-top: 2px; }
        .favorite-btn { cursor: pointer; font-size: 22px; color: #777; margin-left: auto; padding: 0 5px; transition: color 0.2s, transform 0.2s; flex-shrink: 0; }
        .favorite-btn.favorited { color: #FF4500; transform: scale(1.1); }
        .knobs-container { display: flex; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .knob { width: 45px; height: 45px; background: #333; border-radius: 50%; margin: 10px; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .message-box { padding: 15px; text-align: center; color: #fff; background-color: transparent; font-style: italic; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #DEB887; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            /* ... (‡§™‡§ø‡§õ‡§≤‡§æ ‡§ú‡•à‡§∏‡§æ, ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ) ... */
            .knob { width: 30px; height: 30px; }
            .main-display { font-size: 12px; min-height: 30px; }
            .now-playing-display { font-size: 12px; }
            #country-select, #search-station { font-size: 14px; }
            #station-list { max-height: 200px; } /* ‡§•‡•ã‡§°‡§º‡•Ä ‡§î‡§∞ ‡§ú‡§ó‡§π */
            #station-list li { font-size: 14px; padding: 10px 8px; }
            .navigation-tabs button { font-size: 12px; padding: 6px 8px;}
            .player-controls button { width: 35px; height: 35px; font-size: 16px;}
            .recording-quality-selector select, .sleep-timer-controls select { font-size: 12px; padding: 4px;}
            .sleep-timer-controls { flex-direction: column; align-items: center; }
            .sleep-timer-controls select { margin-top: 5px; }
            #sleep-timer-display { margin-left: 0; margin-top: 5px; }
        }
    </style>
</head>
<body>
    <div class="radio-container">
        <div class="display-area">
            <div class="main-display">
                <span class="playing-info">‡§∞‡•á‡§°‡§ø‡§Ø‡•ã ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à!</span>
                <span class="status-info"></span>
            </div>
            <div class="now-playing-display">‡§Ö‡§≠‡•Ä ‡§ï‡•Å‡§õ ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§ú ‡§∞‡§π‡§æ</div>
            <!-- ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§ï‡•à‡§®‡§µ‡§æ‡§∏ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ -->
        </div>

        <div class="player-controls-area">
            <div class="player-controls">
                <button id="prev-station-btn" title="‡§™‡§ø‡§õ‡§≤‡§æ ‡§∏‡•ç‡§ü‡•á‡§∂‡§®" disabled>&#9664;</button>
                <button id="record-btn" title="‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç">‚è∫Ô∏è</button>
                <button id="stop-save-btn" title="‡§∞‡•ã‡§ï‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç" style="display:none;">‚èπÔ∏èüíæ</button>
                <button id="cancel-record-btn" title="‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç" style="display:none;">‚ùå</button>
                <button id="next-station-btn" title="‡§Ö‡§ó‡§≤‡§æ ‡§∏‡•ç‡§ü‡•á‡§∂‡§®" disabled>&#9654;</button>
            </div>
            <div class="recording-quality-selector">
                <label for="quality-select">‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ (WebM/Opus):</label>
                <select id="quality-select">
                    <option value="128">‡§â‡§ö‡•ç‡§ö (‚âà128kbps)</option>
                    <option value="96" selected>‡§Æ‡§ß‡•ç‡§Ø‡§Æ (‚âà96kbps)</option>
                    <option value="64">‡§®‡§ø‡§Æ‡•ç‡§® (‚âà64kbps)</option>
                    <option value="32">‡§¨‡§π‡•Å‡§§ ‡§®‡§ø‡§Æ‡•ç‡§® (‚âà32kbps)</option>
                </select>
            </div>
             <div class="sleep-timer-controls">
                <label for="sleep-timer-select">‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞:</label>
                <select id="sleep-timer-select">
                    <option value="0">‡§¨‡§Ç‡§¶</option>
                    <option value="1">1 ‡§Æ‡§ø (‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£)</option>
                    <option value="15">15 ‡§Æ‡§ø‡§®‡§ü</option>
                    <option value="30">30 ‡§Æ‡§ø‡§®‡§ü</option>
                    <option value="60">60 ‡§Æ‡§ø‡§®‡§ü</option>
                    <option value="90">90 ‡§Æ‡§ø‡§®‡§ü</option>
                </select>
                <span id="sleep-timer-display"></span>
            </div>
        </div>
        <audio controls id="audio-player"></audio>

        <div class="navigation-tabs">
            <button id="show-country-btn" class="active">‡§¶‡•á‡§∂ ‡§∏‡•á</button>
            <button id="show-favorites-btn">‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ</button>
            <button id="show-hindi-stations-btn">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
            <button id="show-urdu-stations-btn">‡§â‡§∞‡•ç‡§¶‡•Ç</button>
            <button id="show-english-stations-btn">‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä</button>
            <button id="share-station-btn" title="‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç" disabled>‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
        </div>

        <div class="country-search-area">
            <select id="country-select">
                <option value="">‡§¶‡•á‡§∂ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
            </select>
            <input type="text" id="search-station" placeholder="‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
        </div>
        <div id="loader" class="loader"></div>
        <ul id="station-list"></ul>

        <div class="knobs-container">
            <div class="knob"></div>
            <div class="knob"></div>
            <div class="knob"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§≤‡•ã‡§° ‡§î‡§∞ ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§");

            const countrySelect = document.getElementById('country-select');
            const stationList = document.getElementById('station-list');
            const audio = document.getElementById('audio-player');
            const mainDisplayPlayingInfo = document.querySelector('.main-display .playing-info');
            const mainDisplayStatusInfo = document.querySelector('.main-display .status-info');
            const nowPlayingDisplay = document.querySelector('.now-playing-display');
            const searchStationInput = document.getElementById('search-station');
            const countrySearchArea = document.querySelector('.country-search-area');
            const loader = document.getElementById('loader');
            const qualitySelect = document.getElementById('quality-select');
            const sleepTimerSelect = document.getElementById('sleep-timer-select');
            const sleepTimerDisplay = document.getElementById('sleep-timer-display');
            // visualizerCanvas ‡§î‡§∞ visualizerCtx ‡§π‡§ü‡§æ ‡§¶‡§ø‡§è ‡§ó‡§è

            const prevStationBtn = document.getElementById('prev-station-btn');
            const nextStationBtn = document.getElementById('next-station-btn');
            const recordBtn = document.getElementById('record-btn');
            const stopSaveBtn = document.getElementById('stop-save-btn');
            const cancelRecordBtn = document.getElementById('cancel-record-btn');

            const navButtons = {
                country: document.getElementById('show-country-btn'),
                favorites: document.getElementById('show-favorites-btn'),
                hindi: document.getElementById('show-hindi-stations-btn'),
                urdu: document.getElementById('show-urdu-stations-btn'),
                english: document.getElementById('show-english-stations-btn'),
            };
            const shareStationBtn = document.getElementById('share-station-btn');

            const defaultFavicon = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLW11c2ljIj48cGF0aCBkPSJNOWcgMTdWNUExIDEgMCAwIDAgOCA0SDZBMSAxIDAgMCAwIDUgNXYxMCIvPjxwYXRoIGQ9Ik0xOCA5di0zYTEgMSAwIDAgMC0xLTFoLTJBMSAxIDAgMCAwIDEzIDZ2MyIvPjxwYXRoIGQ9Ik0xMSAxNXYtM2ExIDEgMCAwIDAtMS0xaC0yYTEgMSAwIDAgMC0xIDF2MyIvPjxwYXRoIGQ9Ik0xNCA1YS41LjUgMCAxIDAtMSAwIC41LjUgMCAxIDAgMSAwWiIvPjxwYXRoIGQ9Ik0xOSA4YS41LjUgMCAxIDAtMSAwIC41LjUgMCAxIDAgMSAwWiIvPjxwYXRoIGQ9Ik02IDE4YS41LjUgMCAxIDAtMSAwIC41LjUgMCAxIDAgMSAwWiIvPjwvc3ZnPg==';
            const radioBrowserServers = ['https://de1.api.radio-browser.info', 'https://nl1.api.radio-browser.info', 'https://at1.api.radio-browser.info'];
            // PROXY_SERVER_URL ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ

            let currentStations = [];
            let currentPlayingStationDetails = null;
            let currentPlayingIndex = -1;
            let activeView = 'country';
            let brokenStreams = JSON.parse(sessionStorage.getItem('brokenRadioStreamsSimple')) || []; // ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§¨‡§¶‡§≤‡•Ä

            let originalPageTitle = document.title;
            let recordingIntervalId;
            let recordingDuration = 0;
            let recordedBlobSize = 0;
            let mediaRecorder;
            let recordedChunks = [];
            let currentMediaRecorderOptions = {};
            let baseDisplayMessage = '‡§∞‡•á‡§°‡§ø‡§Ø‡•ã ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à!';
            let userIntendsToCancel = false;
            let sleepTimeoutId = null;
            let sleepTimerIntervalId = null;
            let sleepEndTime = 0;

            // ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§ö‡§∞ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§è ‡§ó‡§è (audioContext, analyser, sourceNode, dataArray, rafId)

            const RECORD_AS_WAV_FOR_MP3 = false; // ‡§á‡§∏‡•á true ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü-‡§∏‡§æ‡§á‡§° MP3 ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç
            let isConvertingToMp3 = false; 

            function showLoader(show) { loader.style.display = show ? 'block' : 'none'; }
            
            function updateActiveNavButton(view) {
                Object.values(navButtons).forEach(btn => btn.classList.remove('active'));
                if (navButtons[view]) navButtons[view].classList.add('active');
                countrySearchArea.style.display = (view === 'country') ? 'block' : 'none';
                searchStationInput.placeholder = (view === 'country') ? "‡§¶‡•á‡§∂ ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§ñ‡•ã‡§ú‡•á‡§Ç..." : "‡§∏‡•ç‡§ü‡•á‡§∂‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç";
            }
            
            let toastTimeoutId;
            function showToast(message, duration = 3000, isError = false, isPersistent = false) {
                if (RECORD_AS_WAV_FOR_MP3 && isConvertingToMp3 && message !== "MP3 ‡§Æ‡•á‡§Ç ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§" && !isPersistent) {
                    console.log("Toast skipped due to MP3 conversion:", message);
                    return;
                }
                
                const defaultColor = '#00FF00'; const statusColor = '#FFFF00'; const errorColor = 'orange';
                mainDisplayStatusInfo.textContent = message;
                if(isError) mainDisplayStatusInfo.style.color = errorColor;
                else if(isPersistent) mainDisplayStatusInfo.style.color = statusColor;
                else mainDisplayStatusInfo.style.color = defaultColor;

                clearTimeout(toastTimeoutId);
                if (!isPersistent && duration > 0) {
                    toastTimeoutId = setTimeout(() => {
                        if (!(RECORD_AS_WAV_FOR_MP3 && isConvertingToMp3) && 
                            !(mediaRecorder && mediaRecorder.state === 'recording') &&
                            !sleepTimerIntervalId) {
                             mainDisplayStatusInfo.textContent = '';
                        }
                    }, duration);
                }
            }
            
            function updateMainDisplayPlayingInfo(text) {
                baseDisplayMessage = text;
                if (!(mediaRecorder && mediaRecorder.state === 'recording') && !sleepTimerIntervalId && !(RECORD_AS_WAV_FOR_MP3 && isConvertingToMp3)) {
                    mainDisplayPlayingInfo.textContent = text;
                    mainDisplayStatusInfo.textContent = '';
                    mainDisplayPlayingInfo.style.color = '#00FF00';
                } else if (mediaRecorder && mediaRecorder.state === 'recording'){
                    mainDisplayPlayingInfo.textContent = text;
                } else if (!mainDisplayPlayingInfo.textContent) {
                    mainDisplayPlayingInfo.textContent = text;
                }
            }

            function getFavorites() { const favorites = localStorage.getItem('radioFavsSimple'); return favorites ? JSON.parse(favorites) : []; } // ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§¨‡§¶‡§≤‡•Ä
            function saveFavorites(favorites) { localStorage.setItem('radioFavsSimple', JSON.stringify(favorites)); }
            function isFavorite(stationuuid) { return getFavorites().includes(stationuuid); }
            function toggleFavorite(stationuuid, buttonElement) {
                let favorites = getFavorites();
                if (favorites.includes(stationuuid)) {
                    favorites = favorites.filter(id => id !== stationuuid);
                    buttonElement.classList.remove('favorited'); buttonElement.textContent = '‚ô°';
                } else {
                    favorites.push(stationuuid);
                    buttonElement.classList.add('favorited'); buttonElement.textContent = '‚ô•';
                }
                saveFavorites(favorites);
                if (activeView === 'favorites' && !favorites.includes(stationuuid)) { loadData('favorites', null, '‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ'); }
            }

            async function fetchWithFallback(path) { // ‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§§‡§∞‡•ç‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
                console.log("Fetching data from path:", path);
                showLoader(true);
                for (const server of radioBrowserServers) { // ‡§ï‡•á‡§µ‡§≤ RadioBrowser ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
                    const fullPath = `${server}${path}`;
                    try {
                        console.log(`Attempting to fetch from: ${fullPath}`);
                        const response = await fetch(fullPath);
                        if (response.ok) { 
                            console.log("Data fetched successfully from:", fullPath); 
                            showLoader(false); 
                            return await response.json(); 
                        }
                        else { console.warn(`Failed to fetch from ${fullPath}, status: ${response.status}`);}
                    } catch (error) { console.error(`‡§∏‡§∞‡•ç‡§µ‡§∞ ${fullPath} ‡§∏‡•á ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:`, error); }
                }
                showLoader(false); 
                console.error("‡§∏‡§≠‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§∞‡•ç‡§∏ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§µ‡§ø‡§´‡§≤ for path:", path);
                throw new Error('‡§∏‡§≠‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§∞‡•ç‡§∏ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§µ‡§ø‡§´‡§≤');
            }

            function playStation(station, indexInList) {
                console.log("Playing station:", station ? station.name : 'Unknown', "at index:", indexInList);
                userIntendsToCancel = false; 
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecordingStream(false, "‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï ‡§¶‡•Ä ‡§ó‡§à‡•§ ‡§™‡§ø‡§õ‡§≤‡§æ ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ (‡§Ø‡§¶‡§ø ‡§ï‡•Å‡§õ ‡§•‡§æ)‡•§"); 
                }

                const streamUrl = station.url_resolved || station.url;
                // ‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§§‡§∞‡•ç‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ, ‡§∏‡•Ä‡§ß‡•á URL ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
                audio.src = streamUrl; 
                audio.crossOrigin = "anonymous"; // CORS ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡§ì‡§Ç ‡§∏‡•á ‡§¨‡§ö‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ (‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó/‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§¶‡§ø ‡§ú‡•ã‡§°‡§º‡§æ ‡§ú‡§æ‡§è)
                console.log("Audio src set to (direct):", streamUrl);

                audio.play().then(() => {
                    console.log("Audio playback started for:", station.name);
                    updateRecordButtonState();
                    // ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
                }).catch(e => {
                    console.error("‡§ë‡§°‡§ø‡§Ø‡•ã ‡§™‡•ç‡§≤‡•á ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", e, "for station:", station.name, "URL:", streamUrl);
                    showToast(`‡§ë‡§°‡§ø‡§Ø‡•ã ‡§™‡•ç‡§≤‡•á ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${station.name}`, 3000, true);
                    if (station.stationuuid && !brokenStreams.includes(station.stationuuid)) {
                        brokenStreams.push(station.stationuuid);
                        sessionStorage.setItem('brokenRadioStreamsSimple', JSON.stringify(brokenStreams));
                        const brokenLi = stationList.querySelector(`li[data-uuid='${station.stationuuid}']`);
                        if(brokenLi) { brokenLi.classList.add('broken-stream'); brokenLi.title = "‡§Ø‡§π ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§ö‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡•Ä ‡§•‡•Ä‡•§"; }
                    }
                    updateRecordButtonState();
                });
                updateMainDisplayPlayingInfo(`‡§¨‡§ú ‡§∞‡§π‡§æ ‡§π‡•à: ${station.name}`);

                currentPlayingStationDetails = { 
                    name: station.name, url: streamUrl, 
                    uuid: station.stationuuid, homepage: station.homepage 
                };
                currentPlayingIndex = indexInList;
                shareStationBtn.disabled = false;
                
                fetchNowPlaying(station.stationuuid);

                document.querySelectorAll('#station-list li').forEach(item => item.classList.remove('playing'));
                const playingLi = stationList.querySelector(`li[data-uuid='${station.stationuuid}']`);
                if(playingLi) playingLi.classList.add('playing');

                if (playingLi && (playingLi.offsetTop < stationList.scrollTop || playingLi.offsetTop + playingLi.offsetHeight > stationList.scrollTop + stationList.offsetHeight)) {
                    playingLi.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                updateNavigationButtonsState();
            }

            function renderStations(stationsToRender, viewType = 'general') {
                console.log("Rendering stations, count:", stationsToRender ? stationsToRender.length : 0, "View type:", viewType);
                stationList.innerHTML = '';
                 if (!stationsToRender || stationsToRender.length === 0) {
                    const li = document.createElement('li'); li.classList.add('message-box');
                    let msg = '‡§ï‡•ã‡§à ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§';
                    if (viewType === 'favorites') msg = '‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§';
                    else if (viewType === 'hindi') msg = '‡§ï‡•ã‡§à ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§';
                    else if (viewType === 'urdu') msg = '‡§ï‡•ã‡§à ‡§â‡§∞‡•ç‡§¶‡•Ç ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§';
                    else if (viewType === 'english') msg = '‡§ï‡•ã‡§à ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§';
                    else if (viewType === 'country') msg = '‡§á‡§∏ ‡§¶‡•á‡§∂ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§';
                    li.textContent = msg; stationList.appendChild(li);
                    updateNavigationButtonsState();
                    return;
                }

                stationsToRender.forEach((station, index) => {
                    if (!station.name || !(station.url_resolved || station.url) ) return;
                    const li = document.createElement('li'); li.setAttribute('data-uuid', station.stationuuid);
                    const faviconImg = document.createElement('img'); faviconImg.classList.add('station-favicon');
                    faviconImg.src = station.favicon || defaultFavicon; faviconImg.alt = "logo";
                    faviconImg.onerror = () => { faviconImg.src = defaultFavicon; };
                    const stationDetailsDiv = document.createElement('div'); stationDetailsDiv.classList.add('station-details');
                    const stationNameSpan = document.createElement('span'); stationNameSpan.classList.add('station-name');
                    stationNameSpan.textContent = station.name.trim(); stationNameSpan.title = station.name.trim();
                    stationDetailsDiv.appendChild(stationNameSpan);
                    if (station.bitrate && station.bitrate > 0) {
                        const bitrateSpan = document.createElement('span'); bitrateSpan.classList.add('station-bitrate');
                        bitrateSpan.textContent = `${station.bitrate} kbps`; stationDetailsDiv.appendChild(bitrateSpan);
                    }
                    const favoriteBtn = document.createElement('span'); favoriteBtn.classList.add('favorite-btn');
                    favoriteBtn.textContent = isFavorite(station.stationuuid) ? '‚ô•' : '‚ô°';
                    if (isFavorite(station.stationuuid)) favoriteBtn.classList.add('favorited');
                    favoriteBtn.title = "‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§ü‡•â‡§ó‡§≤ ‡§ï‡§∞‡•á‡§Ç";
                    favoriteBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFavorite(station.stationuuid, favoriteBtn); });
                    li.appendChild(faviconImg); li.appendChild(stationDetailsDiv); li.appendChild(favoriteBtn);
                    if (brokenStreams.includes(station.stationuuid)) {
                        li.classList.add('broken-stream'); li.title = "‡§Ø‡§π ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§ö‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡•Ä ‡§•‡•Ä‡•§";
                    }
                    li.addEventListener('click', () => { playStation(station, index); });
                    stationList.appendChild(li);
                });
                updateNavigationButtonsState();
            }
            
            function updateNavigationButtonsState(){
                const hasStations = currentStations && currentStations.length > 0;
                const isPlaying = currentPlayingIndex !== -1 && !audio.paused && audio.src && audio.readyState >= 2;

                prevStationBtn.disabled = !isPlaying || currentPlayingIndex <= 0;
                nextStationBtn.disabled = !isPlaying || currentPlayingIndex >= currentStations.length - 1;
                updateRecordButtonState();
            }

            async function fetchNowPlaying(stationuuid) {
                nowPlayingDisplay.textContent = "‡§ó‡•Ä‡§§ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...";
                try {
                    const playInfoServer = radioBrowserServers[0];
                    const response = await fetch(`${playInfoServer}/json/playinfo/${stationuuid}`);
                    if(response.ok){
                        const playInfo = await response.json();
                        if (playInfo && playInfo.length > 0 && playInfo[0].title) {
                            nowPlayingDisplay.textContent = `‡§Ö‡§≠‡•Ä ‡§¨‡§ú ‡§∞‡§π‡§æ ‡§π‡•à: ${playInfo[0].title}`;
                        } else {
                            nowPlayingDisplay.textContent = "‡§Ö‡§≠‡•Ä ‡§¨‡§ú ‡§∞‡§π‡•á ‡§ó‡•Ä‡§§ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§";
                        }
                    } else {
                         nowPlayingDisplay.textContent = "‡§ó‡•Ä‡§§ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•Ä‡•§";
                    }
                } catch (error) {
                    console.error('"‡§Ö‡§≠‡•Ä ‡§¨‡§ú ‡§∞‡§π‡§æ ‡§π‡•à" ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                    nowPlayingDisplay.textContent = "‡§ó‡•Ä‡§§ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§";
                }
            }

            async function loadData(type, param, nameForDisplay) {
                console.log("Loading data for type:", type, "Param:", param);
                userIntendsToCancel = false;
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecordingStream(false, "‡§¶‡•É‡§∂‡•ç‡§Ø ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï ‡§¶‡•Ä ‡§ó‡§à‡•§ ‡§™‡§ø‡§õ‡§≤‡§æ ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ (‡§Ø‡§¶‡§ø ‡§ï‡•Å‡§õ ‡§•‡§æ)‡•§");
                }
                // MP3 ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ isConvertingToMp3 ‡§ú‡§æ‡§Ç‡§ö ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à

                activeView = type; updateActiveNavButton(activeView); searchStationInput.value = ''; 
                let apiUrlPath; let displayMessagePrefix = nameForDisplay || type;
                updateMainDisplayPlayingInfo(`${displayMessagePrefix} ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...`);
                mainDisplayPlayingInfo.style.color = '#00FF00';

                switch (type) {
                    case 'country':
                        if (!param) { currentStations = []; stationList.innerHTML = ''; 
                                      updateMainDisplayPlayingInfo('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§¶‡•á‡§∂ ‡§ö‡•Å‡§®‡•á‡§Ç'); 
                                      updateNavigationButtonsState(); return; }
                        apiUrlPath = `/json/stations/bycountrycodeexact/${param}?order=clickcount&reverse=true&limit=150&hidebroken=true`;
                        break;
                    case 'favorites':
                        const favoriteUUIDs = getFavorites();
                        if (favoriteUUIDs.length === 0) { currentStations = []; renderStations([], 'favorites'); 
                                                          updateMainDisplayPlayingInfo('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•ç‡§ü‡•á‡§∂‡§® (0)'); 
                                                          updateNavigationButtonsState(); return; }
                        apiUrlPath = `/json/stations/byuuid?uuids=${favoriteUUIDs.join(',')}&hidebroken=true`;
                        break;
                    case 'hindi': case 'urdu': case 'english':
                        apiUrlPath = `/json/stations/bylanguageexact/${type}?order=clickcount&reverse=true&limit=150&hidebroken=true`;
                        break;
                    default: console.error('‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:', type); return;
                }

                try {
                    stationList.innerHTML = ''; 
                    const stations = await fetchWithFallback(apiUrlPath); // useRadioBrowserServers = true ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á
                    currentStations = stations.filter(s => s.name && (s.url_resolved || s.url));
                    renderStations(currentStations, type);
                    
                    let countMsg = currentStations.length > 0 ? `(${currentStations.length})` : '';
                    let newBaseDisplayMsg;
                    if (type === 'country' && param) {
                         const countryName = countrySelect.options[countrySelect.selectedIndex]?.text || param;
                         newBaseDisplayMsg = `"${countryName}" ‡§ï‡•á ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ${countMsg}`;
                    } else {
                         newBaseDisplayMsg = `${displayMessagePrefix} ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ${countMsg}`;
                    }
                    if (currentStations.length === 0) {
                        newBaseDisplayMsg = (type === 'favorites') ? '‡§ï‡•ã‡§à ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç' : `‡§ï‡•ã‡§à ${displayMessagePrefix} ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ`;
                    }
                     updateMainDisplayPlayingInfo(newBaseDisplayMsg);

                } catch (error) {
                    updateMainDisplayPlayingInfo(`${displayMessagePrefix} ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø`);
                    stationList.innerHTML = `<li class="message-box">${displayMessagePrefix} ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø</li>`;
                    console.error(error);
                }
                updateNavigationButtonsState();
            }

            fetchWithFallback('/json/countries') // useRadioBrowserServers = true ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á
                .then(countries => {
                    countries.sort((a, b) => a.name.localeCompare(b.name));
                    countries.forEach(country => {
                        const option = document.createElement('option'); option.value = country.iso_3166_1; option.textContent = country.name; countrySelect.appendChild(option);
                    });
                    updateMainDisplayPlayingInfo('‡§¶‡•á‡§∂ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§Ø‡§æ ‡§≠‡§æ‡§∑‡§æ ‡§ü‡•à‡§¨ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç');
                })
                .catch(error => { updateMainDisplayPlayingInfo('‡§¶‡•á‡§∂‡•ã‡§Ç ‡§ï‡•ã ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø'); console.error(error); });

            function clearSleepTimer(showMessage = false) {
                if (sleepTimeoutId) { clearTimeout(sleepTimeoutId); sleepTimeoutId = null; }
                if (sleepTimerIntervalId) { clearInterval(sleepTimerIntervalId); sleepTimerIntervalId = null; }
                sleepTimerDisplay.textContent = '';
                if (!(mediaRecorder && mediaRecorder.state === 'recording')) {
                    mainDisplayStatusInfo.textContent = ''; 
                }
                if (showMessage) showToast("‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§¨‡§Ç‡§¶‡•§", 2000);
                console.log("‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§∏‡§æ‡§´‡§º ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§");
            }

            function updateSleepTimerDisplay() {
                const remainingTime = Math.max(0, Math.round((sleepEndTime - Date.now()) / 1000));
                if (remainingTime > 0) {
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    const timerText = `‡§∏‡•ç‡§≤‡•Ä‡§™: ${minutes}m ${seconds}s`;
                    sleepTimerDisplay.textContent = timerText;
                    if (!(mediaRecorder && mediaRecorder.state === 'recording')) { // MP3 ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§ú‡§æ‡§Ç‡§ö ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à
                        mainDisplayStatusInfo.textContent = timerText;
                        mainDisplayStatusInfo.style.color = '#FFD700';
                    }
                } else {
                    sleepTimerDisplay.textContent = '‡§∏‡§Æ‡§æ‡§™‡•ç‡§§!';
                    clearSleepTimer(); 
                }
            }

            sleepTimerSelect.addEventListener('change', function() {
                clearSleepTimer();
                const minutes = parseInt(this.value);
                if (minutes > 0) {
                    const milliseconds = minutes * 60 * 1000;
                    sleepEndTime = Date.now() + milliseconds;
                    sleepTimeoutId = setTimeout(() => {
                        console.log("‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§! ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∞‡•ã‡§ï‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
                        audio.pause();
                        audio.src = ''; 
                        showToast(`‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ (${minutes} ‡§Æ‡§ø‡§®‡§ü) ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡•§ ‡§∞‡•á‡§°‡§ø‡§Ø‡•ã ‡§¨‡§Ç‡§¶‡•§`, 5000);
                        clearSleepTimer(); 
                        updateRecordButtonState(); 
                        updateNavigationButtonsState(); 
                    }, milliseconds);
                    sleepTimerIntervalId = setInterval(updateSleepTimerDisplay, 1000);
                    updateSleepTimerDisplay();
                    showToast(`${minutes} ‡§Æ‡§ø‡§®‡§ü ‡§ï‡§æ ‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§∏‡•á‡§ü‡•§`, 3000);
                } else {
                    clearSleepTimer(true);
                }
            });

            // ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§∏‡§≠‡•Ä ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§î‡§∞ ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§è ‡§ó‡§è
            // setupAudioContextAndVisualizer, connectSourceToVisualizer, drawVisualizerLoop
            // ‡§î‡§∞ audio 'canplay' ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞

            async function startRecordingStream() {
                console.log("startRecordingStream called");
                userIntendsToCancel = false;
                if (audio.paused || !audio.src || audio.readyState < 2) {
                    showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§ö‡§≤‡§æ‡§è‡§Ç‡•§", 3000, true); return;
                }
                // captureStream ‡§ï‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§§‡§æ ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à)
                if (!audio.captureStream) { 
                    showToast('‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∏‡§Ç‡§≠‡§µ ‡§®‡§π‡•Ä‡§Ç‡•§', 4000, true);
                    return;
                }

                try {
                    const stream = audio.captureStream(); // ‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä CORS ‡§™‡§∞ ‡§®‡§ø‡§∞‡•ç‡§≠‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à
                    console.log("Audio stream captured:", stream);
                    const selectedBitrate = parseInt(qualitySelect.value) * 1000;

                    currentMediaRecorderOptions = { mimeType: 'audio/webm; codecs=opus', audioBitsPerSecond: selectedBitrate };
                    if (!MediaRecorder.isTypeSupported(currentMediaRecorderOptions.mimeType)) {
                        console.warn(`${currentMediaRecorderOptions.mimeType} ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ogg/opus ‡§Ü‡§ú‡§º‡§Æ‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§`);
                        currentMediaRecorderOptions.mimeType = 'audio/ogg; codecs=opus';
                        currentMediaRecorderOptions.audioBitsPerSecond = selectedBitrate;
                        if (!MediaRecorder.isTypeSupported(currentMediaRecorderOptions.mimeType)) {
                            showToast('WebM/Opus ‡§Ø‡§æ Ogg/Opus ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 3000, true); return;
                        }
                    }
                    console.log("MediaRecorder options:", currentMediaRecorderOptions);
                    
                    mediaRecorder = new MediaRecorder(stream, currentMediaRecorderOptions);
                    console.log("MediaRecorder instance created.");
                    recordedChunks = []; recordedBlobSize = 0;

                    mediaRecorder.ondataavailable = (event) => {
                        console.log("ondataavailable event, data size:", event.data.size);
                        if (event.data.size > 0) { recordedChunks.push(event.data); recordedBlobSize += event.data.size; }
                    };

                    mediaRecorder.onstop = async () => { // MP3 ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã async ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç
                        console.log("onstop event triggered. userIntendsToCancel:", userIntendsToCancel, "recordedChunks.length:", recordedChunks.length);
                        stopSaveBtn.classList.remove('recording-active');
                        cancelRecordBtn.classList.remove('recording-active');
                        document.title = originalPageTitle;
                        if (recordingIntervalId) clearInterval(recordingIntervalId);
                        recordingIntervalId = null;
                        mainDisplayStatusInfo.textContent = '';

                        if (userIntendsToCancel) {
                            showToast("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡•Ä ‡§ó‡§à‡•§", 3000);
                            updateMainDisplayPlayingInfo(baseDisplayMessage);
                            updateRecordButtonState();
                            disablePlayerControls(false);
                            userIntendsToCancel = false;
                            recordedChunks = [];
                            return;
                        }

                        if (recordedChunks.length === 0) {
                            showToast("‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§", 3000, true);
                            updateMainDisplayPlayingInfo(baseDisplayMessage);
                            updateRecordButtonState();
                            disablePlayerControls(false);
                            return;
                        }

                        const recordedBlob = new Blob(recordedChunks, { type: currentMediaRecorderOptions.mimeType });
                        console.log("Blob created for saving. Type:", recordedBlob.type, "Size:", recordedBlob.size);
                        recordedChunks = [];

                        // ‡§∏‡•Ä‡§ß‡§æ WebM/Opus ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°
                        if (recordedBlob.size > 0) {
                            downloadBlob(recordedBlob, `${generateFilename()}_q${qualitySelect.value}.${currentMediaRecorderOptions.mimeType.split('/')[1].split(';')[0]}`);
                            showToast("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à!", 5000);
                        } else {
                            showToast("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§°‡•á‡§ü‡§æ ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à, ‡§∏‡§π‡•á‡§ú‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§æ‡•§", 3000, true);
                        }
                        updateMainDisplayPlayingInfo(baseDisplayMessage);
                        updateRecordButtonState();
                        disablePlayerControls(false); // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§ï‡•â‡§≤ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à
                    };
                    
                    mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', event.error);
                        showToast(`‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.error.name}.`, 5000, true);
                        if (recordingIntervalId) clearInterval(recordingIntervalId);
                        recordingIntervalId = null;
                        document.title = originalPageTitle;
                        updateMainDisplayPlayingInfo(baseDisplayMessage);
                        mainDisplayStatusInfo.textContent = '';
                        stopSaveBtn.classList.remove('recording-active');
                        cancelRecordBtn.classList.remove('recording-active');
                        updateRecordButtonState();
                        disablePlayerControls(false);
                    };

                    mediaRecorder.start(1000); 
                    console.log("MediaRecorder started.");
                    recordingDuration = 0;
                    updateRecordingDisplay(); 

                    document.title = "üî¥ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó... - " + originalPageTitle;
                    showToast("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•Å‡§à!", 2000);
                    updateRecordButtonState();

                    recordingIntervalId = setInterval(() => {
                        recordingDuration++;
                        updateRecordingDisplay();
                    }, 1000);

                } catch (err) {
                    console.error("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", err);
                    showToast("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§", 5000, true);
                    updateRecordButtonState();
                }
            }

            function stopRecordingStream(save = true, stopMessage = "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•Ä ‡§ó‡§à‡•§") {
                userIntendsToCancel = !save; 
                console.log("stopRecordingStream called. saveFile (userIntendsToCancel will be !saveFile):", save, "state:", mediaRecorder ? mediaRecorder.state : "n/a");
                
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    console.log("Stopping MediaRecorder. User intends to cancel:", userIntendsToCancel);
                    mediaRecorder.stop();
                } 
                 else { 
                    console.log("MediaRecorder not recording or not initialized when stop was called.");
                    if (recordingIntervalId) clearInterval(recordingIntervalId);
                    recordingIntervalId = null;
                    document.title = originalPageTitle;
                    updateMainDisplayPlayingInfo(baseDisplayMessage);
                    mainDisplayStatusInfo.textContent = '';
                    updateRecordButtonState();
                }
                stopSaveBtn.classList.remove('recording-active');
                cancelRecordBtn.classList.remove('recording-active');
            }
            
            function updateRecordingDisplay() {
                const minutes = Math.floor(recordingDuration / 60).toString().padStart(2, '0');
                const seconds = (recordingDuration % 60).toString().padStart(2, '0');
                const sizeMB = (recordedBlobSize / (1024 * 1024)).toFixed(2);
                const statusText = `‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó: ${minutes}:${seconds} (${sizeMB} MB) üî¥`;
                mainDisplayStatusInfo.textContent = statusText;
                mainDisplayStatusInfo.style.color = '#00FF00';
                if(currentPlayingStationDetails && mainDisplayPlayingInfo.textContent !== `‡§¨‡§ú ‡§∞‡§π‡§æ ‡§π‡•à: ${currentPlayingStationDetails.name}`) {
                    mainDisplayPlayingInfo.textContent = `‡§¨‡§ú ‡§∞‡§π‡§æ ‡§π‡•à: ${currentPlayingStationDetails.name}`;
                } else if (!currentPlayingStationDetails && mainDisplayPlayingInfo.textContent !== baseDisplayMessage) {
                     mainDisplayPlayingInfo.textContent = baseDisplayMessage;
                }
            }

            function generateFilename() { return currentPlayingStationDetails ? currentPlayingStationDetails.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'radio'; }
            
            function downloadBlob(blob, filename) {
                if (!blob || blob.size === 0) {
                    console.error("‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Blob ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à‡•§");
                    showToast("‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", 3000, true);
                    return;
                }
                console.log(`Attempting to download: ${filename}, size: ${blob.size}`);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                try {
                    a.click();
                    console.log("Download click triggered for", filename);
                } catch (e) {
                    console.error("a.click() ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", e);
                    showToast("‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§", 3000, true);
                }
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    if (a.parentElement) { document.body.removeChild(a); }
                    console.log("Blob URL revoked and <a> removed for", filename);
                }, 300);
            }

            function updateRecordButtonState() {
                const canRecord = !audio.paused && audio.src && audio.readyState >= 2;

                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    recordBtn.style.display = 'none';
                    stopSaveBtn.style.display = 'inline-block';
                    cancelRecordBtn.style.display = 'inline-block';
                    stopSaveBtn.disabled = false;
                    cancelRecordBtn.disabled = false;
                    stopSaveBtn.classList.add('recording-active');
                    cancelRecordBtn.classList.add('recording-active');
                    recordBtn.classList.remove('can-record');
                } 
                // isConvertingToMp3 ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à
                else {
                    recordBtn.style.display = 'inline-block';
                    stopSaveBtn.style.display = 'none';
                    cancelRecordBtn.style.display = 'none';
                    recordBtn.disabled = !canRecord;
                    stopSaveBtn.classList.remove('recording-active');
                    cancelRecordBtn.classList.remove('recording-active');
                    if (canRecord) {
                         recordBtn.classList.add('can-record');
                         recordBtn.style.color = 'green';
                    } else {
                        recordBtn.classList.remove('can-record');
                        recordBtn.style.color = '#666';
                    }
                }
            }
            
            function disablePlayerControls(disable) {
                prevStationBtn.disabled = disable || !(currentPlayingIndex > 0 && currentStations.length > 0 && !audio.paused && audio.readyState >=2);
                nextStationBtn.disabled = disable || !(currentPlayingIndex < currentStations.length - 1 && currentStations.length > 0 && !audio.paused && audio.readyState >=2);
                shareStationBtn.disabled = disable || !(currentPlayingStationDetails && !audio.paused);
                
                Object.values(navButtons).forEach(btn => {
                    if(btn !== shareStationBtn) btn.disabled = disable 
                });
                countrySelect.disabled = disable;
                searchStationInput.disabled = disable;
                qualitySelect.disabled = disable;
                sleepTimerSelect.disabled = disable;
                
                stationList.style.pointerEvents = disable ? 'none' : 'auto';
                stationList.style.opacity = disable ? 0.5 : 1;
                
                if(disable) {
                    recordBtn.disabled = true;
                    recordBtn.classList.remove('can-record');
                    recordBtn.style.color = '#666';
                    stopSaveBtn.disabled = true;
                    cancelRecordBtn.disabled = true;
                } else {
                    updateRecordButtonState();
                    const isPlaying = currentPlayingIndex !== -1 && !audio.paused && audio.src && audio.readyState >= 2;
                    prevStationBtn.disabled = !isPlaying || currentPlayingIndex <= 0;
                    nextStationBtn.disabled = !isPlaying || currentPlayingIndex >= currentStations.length - 1;
                }
            }

            recordBtn.addEventListener('click', startRecordingStream);
            stopSaveBtn.addEventListener('click', () => {
                console.log("Stop & Save button clicked by user.");
                stopRecordingStream(true, "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•Ä ‡§ó‡§à, ‡§∏‡§π‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...");
            });
            cancelRecordBtn.addEventListener('click', () => {
                console.log("Cancel Record button clicked by user.");
                stopRecordingStream(false, "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡•Ä ‡§ó‡§à‡•§");
            });

            audio.addEventListener('play', () => { 
                console.log("Audio 'play' event");
                shareStationBtn.disabled = false; 
                updateRecordButtonState(); 
                // ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
            });
            audio.addEventListener('pause', () => { 
                console.log("Audio 'pause' event");
                updateRecordButtonState(); 
                // ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
            });
            audio.addEventListener('ended', () => { 
                 console.log("Audio 'ended' event");
                shareStationBtn.disabled = true; currentPlayingStationDetails = null; 
                const playingLi = stationList.querySelector('li.playing'); if (playingLi) playingLi.classList.remove('playing');
                nowPlayingDisplay.textContent = ''; updateRecordButtonState();
                // ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
            });
            audio.addEventListener('error', (e) => { 
                console.error("Audio error event:", e);
                showToast('‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§', 3000, true);
                updateRecordButtonState(); 
                if (currentPlayingStationDetails && currentPlayingStationDetails.uuid && !brokenStreams.includes(currentPlayingStationDetails.uuid)) {
                    brokenStreams.push(currentPlayingStationDetails.uuid);
                    sessionStorage.setItem('brokenRadioStreamsSimple', JSON.stringify(brokenStreams));
                    const li = stationList.querySelector(`li[data-uuid='${currentPlayingStationDetails.uuid}']`);
                    if(li) li.classList.add('broken-stream');
                }
                // ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
            });
            audio.addEventListener('emptied', () => {
                console.log("Audio 'emptied' event (src changed or reset)");
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecordingStream(false, "‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï ‡§¶‡•Ä ‡§ó‡§à‡•§");
                }
                shareStationBtn.disabled = true; currentPlayingStationDetails = null; updateRecordButtonState();
                // ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
            });
            
            navButtons.country.addEventListener('click', () => { activeView = 'country'; updateActiveNavButton(activeView); 
                                                              if (countrySelect.value) loadData('country', countrySelect.value); 
                                                              else { currentStations = []; stationList.innerHTML = ''; updateMainDisplayPlayingInfo('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§¶‡•á‡§∂ ‡§ö‡•Å‡§®‡•á‡§Ç'); updateNavigationButtonsState(); } });
            countrySelect.addEventListener('change', () => loadData('country', countrySelect.value));
            navButtons.favorites.addEventListener('click', () => loadData('favorites', null, '‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ'));
            navButtons.hindi.addEventListener('click', () => loadData('hindi', null, '‡§π‡§ø‡§Ç‡§¶‡•Ä'));
            navButtons.urdu.addEventListener('click', () => loadData('urdu', null, '‡§â‡§∞‡•ç‡§¶‡•Ç'));
            navButtons.english.addEventListener('click', () => loadData('english', null, '‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä'));

            searchStationInput.addEventListener('input', () => {
                const searchTerm = searchStationInput.value.toLowerCase(); if (!currentStations) return;
                const filteredStations = currentStations.filter(station => station.name.toLowerCase().includes(searchTerm));
                renderStations(filteredStations, activeView);
            });
            
            shareStationBtn.addEventListener('click', async () => {
                 if (currentPlayingStationDetails) {
                    const { name, url, homepage } = currentPlayingStationDetails; // url ‡§Ö‡§¨ ‡§Æ‡•Ç‡§≤ url ‡§π‡•à
                    const shareData = { title: `‡§∏‡•Å‡§®‡§ø‡§è ${name}`, text: `‡§Æ‡•à‡§Ç World FM ‡§™‡§∞ ${name} ‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å! ‡§Ü‡§™ ‡§≠‡•Ä ‡§∏‡•Å‡§®‡•á‡§Ç: ${homepage || url}`, url: homepage || url };
                    try {
                        if (navigator.share) { await navigator.share(shareData); } 
                        else { const shareText = `‡§∏‡•ç‡§ü‡•á‡§∂‡§®: ${name}\n‡§≤‡§ø‡§Ç‡§ï: ${shareData.url}`; prompt("‡§Ø‡§π ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç (‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç):", shareText); }
                    } catch (err) { const shareText = `‡§∏‡•ç‡§ü‡•á‡§∂‡§®: ${name}\n‡§≤‡§ø‡§Ç‡§ï: ${shareData.url}`; prompt("‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§Ø‡§π ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç:", shareText); }
                }
            });
            
            updateActiveNavButton(activeView);
            updateRecordButtonState();
            updateNavigationButtonsState(); 
            updateMainDisplayPlayingInfo(baseDisplayMessage);
            console.log("‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§Ü‡§∞‡§Ç‡§≠‡§ø‡§ï‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£‡•§");
        });
    </script>
</body>
</html>
